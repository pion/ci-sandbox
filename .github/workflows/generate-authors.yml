#
# DO NOT EDIT THIS FILE
#
# It is automatically copied from https://github.com/pion/.goassets repository.
# If this repository should have package specific CI config,
# remove the repository name from .goassets/.github/workflows/assets-sync.yml.
#
# If you want to update the shared CI config, send a PR to
# https://github.com/pion/.goassets instead of this repository.
#

name: generate-authors

on:
  pull_request:

jobs:
  generate-authors:
    runs-on: ubuntu-latest
    if: github.actor != 'pionbot'
    steps:
    - uses: actions/checkout@v2
      if: "!github.pull_request.head.repo.fork"
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        token: ${{ secrets.PIONBOT_PRIVATE_KEY }}
    - uses: actions/checkout@v2
      if: github.pull_request.head.repo.fork
      with:
        repository: ${{ github.pull_request.head.repo.full_name }}
        ref: ${{ github.pull_request.head.ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate the authors file
      run: .github/generate-authors.sh

    - name: Add the authors file to git
      run: git add AUTHORS.txt

    - name: Get last commit message
      id: last-commit-message
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        COMMIT_MSG="${COMMIT_MSG//'%'/'%25'}"
        COMMIT_MSG="${COMMIT_MSG//$'\n'/'%0A'}"
        COMMIT_MSG="${COMMIT_MSG//$'\r'/'%0D'}"
        echo "::set-output name=msg::$COMMIT_MSG"

    - name: Get last commit author
      id: last-commit-author
      run: |
        echo "::set-output name=msg::$(git log -1 --pretty='%aN <%ae>')"

    - name: Check if AUTHORS.txt file has changed
      id: git-status-output
      run: |
        echo "::set-output name=msg::$(git status -s | wc -l)"

    - name: Commit and push
      if: "steps.git-status-output.outputs.msg != '0' && !github.pull_request.head.repo.fork"
      run: |
        git config user.email $(echo "${{ steps.last-commit-author.outputs.msg }}" | sed 's/\(.\+\) <\(\S\+\)>/\2/')
        git config user.name $(echo "${{ steps.last-commit-author.outputs.msg }}" | sed 's/\(.\+\) <\(\S\+\)>/\1/')
        git add AUTHORS.txt
        git commit --amend --no-edit
        git push --force https://github.com/${GITHUB_REPOSITORY} $(git symbolic-ref -q --short HEAD)

    - name: Notify updating AUTHORS.txt
      if: steps.git-status-output.outputs.msg != '0' && github.pull_request.head.repo.fork
      run: |
        patch="$(git diff)"
        line=$(echo "${patch}" | sed -n '/^@@/s/@@ -\([0-9]\)\+,.*/\1/p' | head -n1)
        code_block='```'
        echo "::error file=AUTHORS.txt,line=${line},col=0::Thank you for your contribution @${{ github.actor }}!%0ADo you mind updating AUTHORS.txt as following?%0A${code_block}%0A${patch}%0A${code_block}\""
